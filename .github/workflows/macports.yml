name: macports

on:
  workflow_dispatch:

env:
  CC: ccache clang -arch x86_64
  CXX: ccache clang++ -arch x86_64
  i386_CC: ccache i686-w64-mingw32-gcc
  x86_64_CC: ccache x86_64-w64-mingw32-gcc
  CPATH: /opt/local/include
  LIBRARY_PATH: /opt/local/lib
  CFLAGS: "-O3 -march=skylake -g0"
  CROSSCFLAGS: "-O3 -g0 -Wno-error=incompatible-pointer-types"
  LDFLAGS: "-Wl,-headerpad_max_install_names -Wl,-rpath,@loader_path/../../Resources/lib -Wl,-rpath,/opt/local/lib"
  MACOSX_DEPLOYMENT_TARGET: 11.0
  WINE_CONFIGURE: ${{ github.workspace }}/wine/configure
  BUILDROOT: ${{ github.workspace }}/build
  INSTALL_DIR: ${{ github.workspace }}/install_tmp
  BUNDLE_NAME: "Wine-CX-25-GPTK3-M4-Pro.wine"

jobs:
  wine-crossover:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bootstrap MacPorts
        run: |
          curl -LO https://raw.githubusercontent.com/Gcenx/crossover-wine-ci/main/.github/workflows/bootstrap.sh
          chmod +x bootstrap.sh
          ./bootstrap.sh

      - name: Adding MacPorts into $PATH
        run: |
          echo "/opt/local/bin" >> $GITHUB_PATH
          echo "/opt/local/sbin" >> $GITHUB_PATH

      - name: Install build dependencies
        run: |
          sudo port install bison ccache gettext mingw-w64 pkgconfig

      - name: Install runtime dependencies (Added GStreamer for Hogwarts)
        run: |
          sudo port install \
            freetype \
            gettext-runtime \
            gnutls-devel \
            libinotify \
            moltenvk \
            libsdl2 \
            gstreamer1 \
            gstreamer1-gst-plugins-base

      - name: Download Crossover 25.1.1
        run: |
          curl -L -o crossover-source.tar.gz https://media.codeweavers.com/pub/crossover/source/crossover-sources-25.1.1.tar.gz

      - name: Extract Crossover Sources
        run: |
          mkdir -p wine
          tar --strip-components=2 -xf crossover-source.tar.gz sources/wine

      - name: Configure wine (Gcenx Base + GStreamer/Vulkan)
        run: |
          mkdir -p ${{ env.BUILDROOT }}/winecx
          pushd ${{ env.BUILDROOT }}/winecx
          ${{ env.WINE_CONFIGURE }} \
            --build=x86_64-apple-darwin \
            --prefix=/ \
            --disable-tests \
            --enable-archs=i386,x86_64 \
            --with-gnutls \
            --with-vulkan \
            --with-sdl \
            --with-gstreamer \
            --with-coreaudio \
            --with-freetype \
            --with-mingw \
            --without-x \
            --without-dbus \
            --without-opengl
          popd

      - name: Build wine
        run: |
          pushd ${{ env.BUILDROOT }}/winecx
          make -j$(sysctl -n hw.ncpu)
          popd

      - name: Install and Structure for Heroic
        run: |
          pushd ${{ env.BUILDROOT }}/winecx
          make install-image DESTDIR="${{ env.INSTALL_DIR }}"
          popd
          
          # 按照 macOS App Bundle 规范构建结构
          FINAL_PATH="${{ github.workspace }}/${{ env.BUNDLE_NAME }}"
          mkdir -p "$FINAL_BUNDLE/Contents/MacOS"
          mkdir -p "$FINAL_BUNDLE/Contents/Resources"
          
          # 封装文件
          cp -R ${{ env.INSTALL_DIR }}/bin/* "$FINAL_PATH/Contents/MacOS/"
          cp -R ${{ env.INSTALL_DIR }}/lib "$FINAL_PATH/Contents/Resources/"
          cp -R ${{ env.INSTALL_DIR }}/share "$FINAL_PATH/Contents/Resources/"
          
          # 关键链接：解决 Heroic 识别问题
          cd "$FINAL_PATH/Contents/MacOS"
          ln -sf wineloader wine
          ln -sf wineloader wine64
          ln -sf ../Resources/lib lib
          ln -sf ../Resources/share share

      - name: Uploading Optimized Bundle
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BUNDLE_NAME }}
          path: ${{ env.BUNDLE_NAME }}
